//functions
(function(){
    'use strict';
    // 分享
    var shareMenu=function(){$(document).on('click','.Share',function(){$('.share-wrap').fadeToggle('slow')})}
    // 侧边栏
    var sidebaraffix=function(){if($('#sidebar').height()&&xb.site_sh){if($('#main').height()>$('#sidebar').height()){var footerHeight=0;if($('#page-footer').length>0){footerHeight=$('#page-footer').outerHeight(true)}$('#sidebar').affix({offset:{top:$('#sidebar').offset().top-xb.site_sh,bottom:$('#footer').outerHeight(true)+footerHeight+6}})}}}
    // 搜索
    var toSearch=function(){$('.search-box').on('click',function(e){$('#searchform').animate({width:'200px'},200),$('#searchform input').css('display','block');$(document).one('click',function(){$('#searchform').animate({width:'0'},100),$('#searchform input').hide()});e.stopPropagation()});$('#searchform').on('click',function(e){e.stopPropagation()})}
    // 回到顶部
    var gotop=function(){$('.gotop-box').on('click',function(event){event.preventDefault();$('html, body').animate({scrollTop:$('html').offset().top},500);return false});$(window).scroll(function(){var $win=$(window);if($win.scrollTop()>200){$('.gotop-box').addClass('active')}else{$('.gotop-box').removeClass('active')}})}
    // 微信图片（暂时没有）
    // todo 看情况实现这个功能
    var wechatpic=function(){$('#wechat-img').mouseout(function(){$('#wechat-pic')[0].style.display='none'});$('#wechat-img').mouseover(function(){$('#wechat-pic')[0].style.display='block'})}
    // 背景图
    var offcanvas=function(){var body=document.getElementById('kratos-wrapper');var sider=document.getElementById('sider-bar');function clear(){body.style.left="0px";body.style.position="relative";sider.style.visibility=" hidden"}var $clone=$('#kratos-menu-wrap').clone();$clone.attr({'id':'offcanvas-menu','class':' '});$clone.find('> ul').attr({'class':'ul-me','id':''});$('#sider-bar').prepend($clone);$('.js-kratos-nav-toggle').on('click',function(){if($('.nav-toggle').hasClass('toon')){$('.nav-toggle').removeClass('toon');$('#offcanvas-menu').css('left','-240px');clear()}else{$('.nav-toggle').addClass('toon');$('#offcanvas-menu').css('left','0px');body.style.left="240px";sider.style.visibility="visible"}});$('#offcanvas-menu a').on('click',function(){$('.nav-toggle').removeClass('toon');$('#offcanvas-menu').css('left','-240px');clear()});$('#offcanvas-menu').css('height',$(window).height());$('#offcanvas-menu').css('left','-240px');clear();$(window).resize(function(){var w=$(window);$('#offcanvas-menu').css('height',w.height());if(w.width()>769){if($('.nav-toggle').hasClass('toon')){$('.nav-toggle').removeClass('toon');$('#offcanvas-menu').css('left','-240px');clear()}}})}
    // 顶部导航栏
    var menu=function(){$(document).click(function(e){var container=$('#sider-bar,.js-kratos-nav-toggle');if(!container.is(e.target)&&container.has(e.target).length===0){if($('.nav-toggle').hasClass('toon')){$('.nav-toggle').removeClass('toon');$('#offcanvas-menu').css('left','-240px');var body=document.getElementById('kratos-wrapper');var sider=document.getElementById('sider-bar');body.style.left="0px";body.style.position="relative";sider.style.visibility=" hidden"}}});$('#kratos-header-section:not(.color-banner) ul>li').hover(function(){$(this).children('ul').slideDown(150)},function(){$(this).children('ul').stop(true,false).slideUp(200)})}
    // 赞助博主
    var donateConfig=function(){$(document).on('click','.Donate',function(){layer.open({offset:['85px','150px'],type:1,area:['300px','370px'],title:'打赏作者',resize:false,scrollbar:false,content:'<div class="donate-box"><div class="meta-pay text-center"><strong>扫一扫支付</strong></div><div class="qr-pay text-center"><img class="pay-img" id="alipay_qr" src="'+globalPost.alipay+'"><img class="pay-img d-none" id="wechat_qr" src="'+globalPost.wechat+'"></div><div class="choose-pay text-center mt-2"><input id="alipay" type="radio" name="pay-method" checked><label for="alipay" class="pay-button"><img src="'+xb.theme+'/static/images/alipay.png"></label><input id="wechatpay" type="radio" name="pay-method"><label for="wechatpay" class="pay-button"><img src="'+xb.theme+'/static/images/wechat.png"></label></div></div>'});$('.choose-pay input[type="radio"]').click(function(){var id=$(this).attr('id');if(id=='alipay'){$('.qr-pay #alipay_qr').removeClass('d-none');$('.qr-pay #wechat_qr').addClass('d-none')};if(id=='wechatpay'){$('.qr-pay #alipay_qr').addClass('d-none');$('.qr-pay #wechat_qr').removeClass('d-none')}})})}
    // OWO表情
    var OwOcfg=function(){if($('#commentform').height()){let OwO_demo=new OwO({logo:'OωO表情',container:document.getElementsByClassName('OwO')[0],target:document.getElementsByClassName('OwO')[0],api:xb.api+'/api/v3/tools/smiles',position:'down',width:'100%',maxHeight:'250px'})}}
    // 显示雪花
    // todo 后续实现这个功能
    var SnowF=function(){var requestAnimationFrame=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(callback){window.setTimeout(callback,1000/60)};window.requestAnimationFrame=requestAnimationFrame;var flakes=[],canvas=document.getElementById("Snow"),ctx=canvas.getContext("2d"),flakeCount=parseInt($('#Snow').attr('data-count')),mX=-100,mY=-100;canvas.width=window.innerWidth;canvas.height=window.innerHeight;function snow(){ctx.clearRect(0,0,canvas.width,canvas.height);for(var i=0;i<flakeCount;i++){var flake=flakes[i],x=mX,y=mY,minDist=parseInt($('#Snow').attr('data-dist')),x2=flake.x,y2=flake.y;var dist=Math.sqrt((x2-x)*(x2-x)+(y2-y)*(y2-y)),dx=x2-x,dy=y2-y;if(dist<minDist){var force=minDist/(dist*dist),xcomp=(x-x2)/dist,ycomp=(y-y2)/dist,deltaV=force/2;flake.velX-=deltaV*xcomp;flake.velY-=deltaV*ycomp}else{flake.velX*=0.98;if(flake.velY<=flake.speed){flake.velY=flake.speed}flake.velX+=Math.cos(flake.step+=.05)*flake.stepSize}ctx.fillStyle="rgba("+$('#Snow').attr('data-color')+","+flake.opacity+")";flake.y+=flake.velY;flake.x+=flake.velX;if(flake.y>=canvas.height||flake.y<=0){reset(flake)}if(flake.x>=canvas.width||flake.x<=0){reset(flake)}ctx.beginPath();ctx.arc(flake.x,flake.y,flake.size,0,Math.PI*2);ctx.fill()}requestAnimationFrame(snow)};function reset(flake){flake.x=Math.floor(Math.random()*canvas.width);flake.y=0;flake.size=(Math.random()*3)+parseInt($('#Snow').attr('data-size'));flake.speed=(Math.random()*1)+parseInt($('#Snow').attr('data-speed'));flake.velY=flake.speed;flake.velX=0;flake.opacity=(Math.random()*0.5)+parseInt($('#Snow').attr('data-opacity'))}function init(){for(var i=0;i<flakeCount;i++){var x=Math.floor(Math.random()*canvas.width),y=Math.floor(Math.random()*canvas.height),size=(Math.random()*3)+parseInt($('#Snow').attr('data-size')),speed=(Math.random()*1)+parseInt($('#Snow').attr('data-speed')),opacity=(Math.random()*0.5)+parseInt($('#Snow').attr('data-opacity'));flakes.push({speed:speed,velY:speed,velX:0,x:x,y:y,size:size,stepSize:(Math.random())/30*parseInt($('#Snow').attr('data-step')),step:0,angle:180,opacity:opacity})}snow()};document.addEventListener('mousemove',function(e){mX=e.clientX,mY=e.clientY});window.addEventListener('resize',function(){canvas.width=window.innerWidth;canvas.height=window.innerHeight});init()}
    //pjax reload
    $.fn.kratos_pjax_reload=function(){sidebaraffix();OwOcfg()}
    // jquery初始化完毕时加载
    $(function(){gotop();sidebaraffix();offcanvas();menu();toSearch();donateConfig();shareMenu();OwOcfg();wechatpic();if($('div').hasClass('xb-snow'))SnowF()});
}());
// 站点时间
var now=new Date();function createtime(){var grt=new Date(xb.ctime);now.setTime(now.getTime()+250);days=(now-grt)/1000/60/60/24;dnum=Math.floor(days);hours=(now-grt)/1000/60/60-(24*dnum);hnum=Math.floor(hours);if(String(hnum).length==1){hnum='0'+hnum}minutes=(now-grt)/1000/60-(24*60*dnum)-(60*hnum);mnum=Math.floor(minutes);if(String(mnum).length==1){mnum='0'+mnum}seconds=(now-grt)/1000-(24*60*60*dnum)-(60*60*hnum)-(60*mnum);snum=Math.round(seconds);if(String(snum).length==1){snum='0'+snum}document.getElementById('span_dt_dt').innerHTML=dnum+'天'+hnum+'小时'+mnum+'分'+snum+'秒'}setInterval('createtime()',250);
// 拷贝事件
// if(xb.copy) document.body.oncopy=function(){alert('已复制所选内容。请务必遵守本站条约！');}
//  动画脚本
new WOW().init();
// 文档系统
if($("#app-doc").length>0){new Vue({el:'#app-doc',data:{docList:[],filterText:'',key:[],check:[],docContent:{title:'',content:''}},watch:{filterText(val){this.$refs.tree.filter(val)}},mounted(){this.getDocList()},methods:{filterNode(value,data){if(!value){return true}return data.label.includes(value)},sideBar(){if($('.sidebar').css('margin-left')==='0px'){$('.sidebar').css('margin-left','-280px')}else{$('.sidebar').css('margin-left','0')}},click(choose){window.history.pushState({id:1,name:'doc'},'测试','/doc/'+choose.id);this.setDocContent(choose.id)},setDocContent(id){xy.net.request(`plugins/docs/${id}`,"GET").then((data)=>{window.scroll(0,0);this.docContent=data})},getDocList(){xy.net.request("plugins/docs","GET").then((data)=>{this.docList=this.DataProcess(data)})},DataProcess(data){let trees=[];if(data!=null){for(let i=0;i<data.length;i++){if(data[i].parent===0){trees.push({id:data[i].id,label:data[i].title})}}trees=this.InsertChild(trees,data)}return trees},InsertChild(trees,data){for(let i=0;i<trees.length;i++){for(let j=0;j<data.length;j++){if(trees[i].id===data[j].parent){if(Object.prototype.hasOwnProperty.call(trees[i],'children')){trees[i].children.push({id:data[j].id,label:data[j].title})}else{trees[i].children=[{id:data[j].id,label:data[j].title}]}}}if(Object.prototype.hasOwnProperty.call(trees[i],'children')){trees[i].children=this.InsertChild(trees[i].children,data)}}return trees}}});const high=$(document).height()-$('#navigation').height()-$('#footer').height()-70;$('#app').css('min-height',high+'px')}
// 评论框移动
$('body').on('click','.comment-reply-link',function(){if($(this).attr('onclick'))return;addComment.moveForm($(this).attr('data-belowelement'),$(this).attr('data-commentid'),$(this).attr('data-respondelement'),$(this).attr('data-postid'));return false});jQuery(document).ready(function(jQuery){var __cancel=jQuery('#cancel-comment-reply-link'),__cancel_text=__cancel.text();addComment={moveForm:function(commId,parentId,respondId){var t=this,div,comm=t.I(commId),respond=t.I(respondId),cancel=t.I('cancel-comment-reply-link'),parent=t.I('comment_parent'),post=t.I('comment_post_ID');__cancel.text(__cancel_text);t.respondId=respondId;if(!t.I('wp-temp-form-div')){div=document.createElement('div');div.id='wp-temp-form-div';div.style.display='none';respond.parentNode.insertBefore(div,respond)}!comm?(temp=t.I('wp-temp-form-div'),t.I('comment_parent').value='0',temp.parentNode.insertBefore(respond,temp),temp.parentNode.removeChild(temp)):comm.parentNode.insertBefore(respond,comm.nextSibling);jQuery('body').animate({scrollTop:jQuery('#respond').offset().top-180},400);parent.value=parentId;cancel.style.display='';cancel.onclick=function(){var t=addComment,temp=t.I('wp-temp-form-div'),respond=t.I(t.respondId);t.I('comment_parent').value='0';if(temp&&respond){temp.parentNode.insertBefore(respond,temp);temp.parentNode.removeChild(temp)}this.style.display='none';this.onclick=null;return false};try{t.I('comment').focus()}catch(e){}return false},I:function(e){return document.getElementById(e)}}});
// 文章点赞和文章评论功能
if($("#kratos-blog-post").length>0){function showMessage(msg){layer.msg(msg,{offset:'150px',})}$("#btn-love").click(function(){xy.net.request('posts/'+globalPost.id+'/liked',"PUT","").then(()=>{showMessage("点赞成功")}).catch((msg)=>{showMessage(msg)})});new Vue({el:'#respond',data:{isLogin:false,postId:globalPost.id,commentData:{email:'',content:'',name:'',post_id:'',user_id:0,parent:0,site:'',avatar:'',level:'',hang:'',uid:''},},created(){if(globalPost.isLogin){const info=JSON.parse(globalUserInfo);this.isLogin=true;this.commentData.avatar=info.avatar;this.commentData.hang=info.hang;this.commentData.email=info.email;this.commentData.name=info.nickname;this.commentData.user_id=info.user_id}},computed:{uid(){return this.commentData.uid},},watch:{uid(uid){xy.net.request("tools/bili_info/"+uid,"GET",{}).then((res)=>{this.commentData.avatar=res.avatar;this.commentData.name=res.nickname;this.commentData.hang=res.hang;this.commentData.level=res.level.toString()})}},methods:{comment(){this.commentData.post_id=this.postId;this.commentData.parent=parseInt($("#comment_parent").val());this.commentData.content=$('#comment').val();let comment=this.commentData;if(comment.name===''){showMessage("请输入昵称")}else if(!xy.validate.checkEmail(comment.email)){showMessage("邮箱格式不正确")}else if(comment.content===''){showMessage("内容不能为空")}else{let token=JSON.parse(xy.tools.getCookie('token'));let head={'user_id':token["user_id"],'token':token['token']};xy.net.request('posts/'+this.postId+'/comments',"POST",this.commentData,head).then(()=>{window.location.reload()}).catch(msg=>showMessage(msg))}}}})}



